# .claude.md

## 文档目的
本文件用于项目交接与长期协作，记录关键约束、回复规范、质量底线与操作边界。新同事接手前，先完整阅读本文件与 `AGENTS.md`。

## 项目关键信息
- 项目名称：`calculation_resource_optimization`
- 主题：面向单机多智能体的语义记忆碎片聚类压缩与偏好保留
- 主文档入口：`gptdeepsearch2_9.md`
- 目标产物：`prior_art/`、`spec/`、`prototype/`、`patent/`、`figures/`、`qa/`

## 回复规范
1. 回复先给结论，再给证据或文件路径。
2. 任何“已完成”都必须能在仓库中定位到文件。
3. 涉及数据结论时，必须给出复现命令或脚本路径。
4. 不确定事项要显式标注“待核验”，禁止伪确定性表述。
5. 专利文本统一使用中文，保持术语一致。

## 工程规范
1. 每次工作必须写进 `logs/work_progress.md`。
2. 进展记录必须包含：
   - 时间戳（`YYYY-MM-DD HH:mm:ss ±HH:MM`）
   - 执行人
   - 评审人（如有）
   - 本次工作内容
   - 文件变更列表
   - 文件评审清单
   - 风险与后续动作
3. 每次交付前执行自查：
   - 结构自查：`qa/structure_check.ps1`
   - 内容自查：术语一致、引用可追溯、命令可执行
4. 如新增流程或规则，需同步更新本文件与 `RUNBOOK.md`。

## 文件评审清单（标准版）
- [ ] 文件路径与命名符合目录约定
- [ ] 内容与目标目录职责一致
- [ ] 术语与既有文档一致
- [ ] 不含明显逻辑冲突或自相矛盾
- [ ] 有可执行/可复现说明（如适用）
- [ ] 关键结论可追溯到来源或脚本输出

## 安全与边界
- 不在仓库中提交密钥、令牌、个人敏感信息。
- 对外部来源信息默认做交叉验证，不单点采信。
- “避碰”仅是降风险措施，不替代专业专利检索与代理意见。

## 交接建议
1. 先读 `logs/work_progress.md` 了解最新进度与风险。
2. 再读 `RUNBOOK.md` 复现环境和检查流程。
3. 按 `AGENTS.md` 的顺序继续推进，不跳步。

---

## Claude (Opus) 评审记录

### 评审 R1 — 2026-02-09 15:20:00 +08:00

**评审范围**：Codex 完成的 M0 阶段全部产物（仓库骨架初始化），共 14 个可评审文件（不含 `.git/` 和 `.claude/settings.local.json`）。

**评审结论**：M0 骨架整体合格，目录结构完整、治理文档齐备、自查脚本可用。但发现 **5 个缺陷（2 个必须修复、3 个建议修复）** 和 **4 条改进建议**。

---

#### 一、逐文件评审清单

| # | 文件 | 路径合规 | 内容职责匹配 | 术语一致 | 无逻辑矛盾 | 可执行/可复现 | 结论可追溯 | 判定 |
|---|------|:--------:|:------------:|:--------:|:----------:|:-------------:|:----------:|:----:|
| 1 | `.claude.md` | PASS | PASS | PASS | PASS | PASS | PASS | PASS |
| 2 | `AGENTS.md` | PASS | PASS | PASS | PASS | PASS | PASS | PASS |
| 3 | `README.md` | PASS | PASS | PASS | PASS | PASS | N/A | PASS |
| 4 | `RUNBOOK.md` | PASS | PASS | PASS | **ISSUE-1** | PASS | N/A | WARN |
| 5 | `gptdeepsearch2_9.md` | PASS | PASS | PASS | PASS | N/A | N/A | PASS |
| 6 | `logs/work_progress.md` | PASS | PASS | PASS | **ISSUE-2** | PASS | PASS | WARN |
| 7 | `qa/structure_check.ps1` | PASS | PASS | N/A | PASS | **ISSUE-3** | N/A | WARN |
| 8 | `qa/review_checklist.md` | PASS | PASS | PASS | PASS | N/A | N/A | PASS |
| 9 | `qa/README.md` | PASS | PASS | PASS | PASS | N/A | N/A | PASS |
| 10 | `prior_art/README.md` | PASS | PASS | PASS | PASS | N/A | N/A | PASS |
| 11 | `spec/README.md` | PASS | PASS | PASS | PASS | N/A | N/A | PASS |
| 12 | `prototype/README.md` | PASS | PASS | PASS | PASS | N/A | N/A | PASS |
| 13 | `patent/README.md` | PASS | PASS | PASS | PASS | N/A | N/A | PASS |
| 14 | `figures/README.md` | PASS | PASS | PASS | PASS | N/A | N/A | PASS |

---

#### 二、缺陷清单

**ISSUE-1 [必须修复] — `RUNBOOK.md` git remote 地址缺失**
- 位置：`RUNBOOK.md` 第 5 行
- 描述：`git clone` 指向 `https://github.com/Deepmind666/calculation_resource_optimization.git`，但实际 git 仓库 **未配置 remote**（`git remote -v` 无输出）。同时 GitHub 上该仓库名为 `calculation_resource_optimization`，但截图显示的是 `memory_cluster_algorithm` 仓库页面，两者不一致。
- 影响：新同事按 RUNBOOK 操作会 clone 失败；且仓库名与 GitHub 实际仓库可能不匹配。
- 建议修复：(1) 执行 `git remote add origin <正确URL>`；(2) 确认 GitHub 仓库名后统一 RUNBOOK 中的 URL。

**ISSUE-2 [必须修复] — `logs/work_progress.md` 文件名拼写错误**
- 位置：`logs/work_progress.md` 第 34 行
- 描述：文件变更列表中写的是 `igures/README.md`，缺少首字母 `f`，应为 `figures/README.md`。
- 影响：日志记录不准确，后续追溯时可能误判文件是否存在。
- 建议修复：将 `igures/README.md` 改为 `figures/README.md`。

**ISSUE-3 [建议修复] — `qa/structure_check.ps1` 检查覆盖不足**
- 位置：`qa/structure_check.ps1` 第 15-22 行
- 描述：`$requiredFiles` 列表未包含 `gptdeepsearch2_9.md`（项目主文档入口）。该文件在 `.claude.md` 中被明确标注为"主文档入口"，但自查脚本不检查其存在性。
- 影响：如果主文档被误删，自查脚本仍会报 PASS。
- 建议修复：将 `gptdeepsearch2_9.md` 加入 `$requiredFiles` 列表。

**ISSUE-4 [建议修复] — `qa/structure_check.ps1` 缺少子目录 README 检查**
- 位置：`qa/structure_check.ps1`
- 描述：脚本只检查目录是否存在，不检查各子目录下的 README.md 是否存在。按 AGENTS.md 的交付目录约定，每个子目录应有说明文件。
- 影响：子目录 README 被删除时不会被检测到。
- 建议修复：在 `$requiredFiles` 中追加各子目录的 `README.md`。

**ISSUE-5 [建议修复] — `RUNBOOK.md` 提交命令使用 `git add .`**
- 位置：`RUNBOOK.md` 第 21 行
- 描述：提交命令直接使用 `git add .`，这可能意外提交 `.claude/settings.local.json` 等本地配置文件或未来可能出现的 `.env` 等敏感文件。
- 影响：违反 `.claude.md` 安全与边界章节"不在仓库中提交密钥、令牌、个人敏感信息"的规定。
- 建议修复：(1) 新增 `.gitignore` 文件，排除 `.claude/`、`*.env`、`__pycache__/` 等；(2) RUNBOOK 中改为 `git add` 指定文件或先检查 `git status`。

---

#### 三、改进建议（非缺陷，但建议在 M1 之前落实）

**SUG-1 — 缺少 `.gitignore` 文件**
- 当前仓库无 `.gitignore`。Python 原型阶段会产生 `__pycache__/`、`*.pyc`、`.env`、`venv/`、`.vscode/`、`.claude/` 等不应入库的文件。
- 建议：在首次 commit 前创建 `.gitignore`，至少包含：
  ```
  __pycache__/
  *.pyc
  .env
  venv/
  .vscode/
  .claude/
  *.tmp
  ```

**SUG-2 — `gptdeepsearch2_9.md` 格式问题**
- 该文件是从外部报告复制而来，存在以下格式瑕疵：
  - 第 1 行为空行，缺少 `#` 标题标记，不符合 Markdown 规范。
  - 第 130-131 行、第 216-217 行出现裸露的 `md` 和 `复制` 字样，疑似从网页复制时残留的 UI 元素（"复制代码"按钮文本）。
  - 第 244 行出现孤立的 `、` 符号，上下文断裂，疑似引用来源名称被截断。
  - 多处引用来源（如第 18-19 行 MemGPT、第 122-123 行 Codex 平台描述）缺少完整的引用链接或文献标识。
- 建议：(1) 添加一级标题；(2) 清理复制残留；(3) 对截断处标注 `[待补全]`。

**SUG-3 — 进展日志缺少"评审人"字段**
- `.claude.md` 工程规范要求进展记录包含"文件评审清单"，但未要求标注"由谁评审"。在双 LLM 协作模式下（Codex 编写 + Claude 评审），日志应区分"作者"与"评审人"。
- 建议：在 `.claude.md` 工程规范中增加字段要求：`评审人：Codex / Claude (Opus) / 人工`。

**SUG-4 — `RUNBOOK.md` 缺少环境依赖说明**
- 当前 RUNBOOK 只有 git 和 PowerShell 命令，未说明后续 prototype 阶段所需的 Python 版本、依赖安装方式等。
- 建议：预留"环境准备"章节，待 M4（prototype）阶段补充 `pip install -r requirements.txt` 等内容。

---

#### 四、`gptdeepsearch2_9.md` 技术内容深度评审

该文件是整个项目的技术蓝图，质量直接决定后续所有产物的方向。以下是技术层面的评审意见：

**4.1 优点**
- 现有技术版图梳理全面，覆盖了 MemGPT、TiMem、EverMemOS、MemBrain、LangGraph 等主要竞品。
- 三个差异化切口（A/B/C）定位精准，避开了宽覆盖专利的正面冲突。
- 将四个核心创新点（偏好契约 + 保真校验 + 预算分配 + 冗余仲裁）组合为技术方案主线，策略合理。
- Master Prompt 的任务拆解（Step 1-7）与质量门槛（Section G）设计严谨。

**4.2 风险与待核验项**
- **[待核验]** 第 41 行引用 US10984781B2、第 44 行引用 US11558334、第 47 行引用 CN111639175B、第 50 行引用"Multi-stage LLM with unlimited context"专利——这些专利号和描述需要在 `prior_art/` 阶段逐一核实原文，确认摘要描述准确。当前仅为 GPT Deep Search 的二手总结，存在幻觉风险。
- **[待核验]** 第 22-25 行提到的 TiMem、EverMemOS 等 2025-2026 工作，需确认论文实际发表状态和内容准确性。
- **[风险]** 第 62 行差异化切口 B 中出现韩文字符"분工"（应为"分工"），疑似 OCR 或复制错误。需修正。
- **[风险]** 文档将"聚类+摘要"降级为实现环节，但 Master Prompt Section D2 的 9 步流程中，步骤 2-3（向量化、聚类）仍占据核心位置。如果权利要求过度依赖聚类步骤，可能与 US10984781B2 等专利产生正面冲突。建议在 spec 阶段明确：独立权利要求的必要技术特征应以"偏好契约+保真校验+预算分配+仲裁"为主体，聚类作为从属权利要求的限定。

---

#### 五、Git 与仓库状态评审

| 检查项 | 状态 | 说明 |
|--------|:----:|------|
| git 初始化 | PASS | `main` 分支已创建 |
| remote 配置 | **FAIL** | `git remote -v` 无输出，未关联 GitHub |
| 首次 commit | **FAIL** | 所有文件均为 untracked，零 commit |
| `.gitignore` | **FAIL** | 不存在，`.claude/` 等本地配置将被误提交 |
| GitHub 仓库一致性 | **待核验** | 用户提供的 URL 为 `calculation_resource_optimization`，但截图显示 `memory_cluster_algorithm` |

**阻塞项**：在 Codex 继续 M1 工作之前，必须先完成：
1. 确认正确的 GitHub 仓库 URL
2. 创建 `.gitignore`
3. `git remote add origin <URL>`
4. 首次 commit 并 push

---

#### 六、评审总结

| 维度 | 评分 | 说明 |
|------|:----:|------|
| 目录结构完整性 | 9/10 | 缺 `.gitignore`，其余完整 |
| 治理文档质量 | 8/10 | `.claude.md`/`AGENTS.md`/`RUNBOOK.md` 规范清晰，缺评审人字段和环境依赖 |
| 自查机制 | 7/10 | 脚本可用但检查覆盖不足（缺主文档、缺子目录 README） |
| 日志规范 | 8/10 | 格式规范、时间戳准确，有一处拼写错误 |
| 技术蓝图质量 | 8/10 | 方向正确、策略合理，但引用需核实、有复制残留 |
| Git/CI 就绪度 | 3/10 | 未 commit、未 push、无 remote、无 .gitignore |

**M0 阶段评审判定：有条件通过（Conditional PASS）**
- 必须修复 ISSUE-1、ISSUE-2 后方可进入 M1。
- 强烈建议在首次 commit 前落实 SUG-1（.gitignore）。

---

#### 七、Codex 下一步行动清单（按优先级）

1. **[阻塞]** 确认 GitHub 仓库 URL 并配置 remote
2. **[阻塞]** 创建 `.gitignore` 并排除本地配置
3. **[阻塞]** 修复 `logs/work_progress.md` 第 34 行拼写错误
4. **[阻塞]** 首次 commit 并 push 到 GitHub
5. **[M1 前]** 修复 `qa/structure_check.ps1` 检查覆盖（ISSUE-3、ISSUE-4）
6. **[M1 前]** 清理 `gptdeepsearch2_9.md` 格式残留（SUG-2）
7. **[M1]** 开始 prior_art 调研，逐一核实技术蓝图中引用的专利号与论文

---

*评审人：Claude (Opus 4.6)*
*评审时间：2026-02-09 15:20:00 +08:00*
*评审范围：M0 全部产物（14 个可评审文件）*
*下次评审触发条件：Codex 完成 ISSUE-1/2 修复 + 首次 commit 后*

---

### 评审 R2 — 2026-02-09 16:00:00 +08:00

**评审范围**：用户更新后的 `gptdeepsearch2_9.md`（365 行）。

**评审结论**：文件存在 **3 个严重问题**，当前版本不可用于指导后续工作。

---

#### 缺陷清单

**ISSUE-6 [必须修复] — 原始技术调研内容被误删**
- 描述：更新后的文件仅保留 Master Prompt（Section A-H）+ AGENTS.md 建议 + 启动指令，但原版中以下关键内容全部丢失：
  - "研究目标与边界"章节
  - "现有技术版图与关键近似点"（MemGPT/TiMem/EverMemOS/MemBrain/LangGraph 分析）
  - "专利避碰：高风险重叠点"（US10984781B2/US11558334/CN111639175B 等 4 项专利）
  - "差异化切口 A/B/C"三条策略
  - "推荐的技术方案"骨架（7 个核心模块详细论述）
  - "面向中国发明专利的文档结构与写作硬约束"
- 影响：Master Prompt 的 D1/D2 只是执行指令，缺少调研论证则 Codex 无法理解设计依据，prior_art 阶段将失去参照基线。
- 建议修复：从原始版本恢复技术调研部分，或将其独立为 `spec/technical_survey.md`。

**ISSUE-7 [必须修复] — GPU/CPU 方案仍残留**
- 位置：第 122-364 行
- 描述：用户已确认"发错了"，但"基于GPU/CPU运行反馈的代码生成优化算法"内容仍在文件中。
- 影响：与本项目主题完全无关，造成文档混乱。
- 建议修复：删除第 122-364 行全部内容。

**ISSUE-8 [必须修复] — 文件开头与中间格式损坏**
- 位置：第 1-4 行、第 89 行、第 110 行、第 117 行
- 描述：第 1-2 行空行，第 3 行裸露 `md`，第 4 行裸露 `复制`（网页复制残留）。第 89、110 行同样有 `md`/`复制`。第 117 行孤立 `、` 符号。
- 建议修复：清理所有复制残留，第 1 行添加正式标题。

---

#### Codex 行动清单（R2）

1. **[阻塞]** 恢复原始技术调研内容（或独立存放到 `spec/technical_survey.md`）
2. **[阻塞]** 删除第 122-364 行 GPU/CPU 无关方案
3. **[阻塞]** 清理第 1-4、89、110、117 行格式残留
4. **[R1 遗留]** 完成 ISSUE-1/2 修复 + `.gitignore` + 首次 commit

---

*评审人：Claude (Opus 4.6)*
*评审时间：2026-02-09 16:00:00 +08:00*

---

#### 附：Claude 主动产出 — 详细版技术开发方案

鉴于用户要求"撰写详细版本的技术开发方案以备技术开发"，Claude 已基于 Master Prompt D1/D2 主线撰写完整方案，存放于 `spec/architecture.md`。该方案覆盖：
- 系统总体架构与模块划分
- 核心数据结构定义（Fragment/Cluster/ClusterMemoryUnit/RetentionContract）
- 9 步流程的详细算法设计与伪代码
- 模块间接口契约
- 技术选型建议
- 实验设计与指标定义

详见 `spec/architecture.md`。

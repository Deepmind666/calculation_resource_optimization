# 说明书（资源调度方向，v2）
- Timestamp: 2026-02-13 11:45:00 +08:00
- 说明: 在 v1 基础上补充 R23 自适应重试实施方式与真机证据，突出“安全+吞吐”双目标闭环。

## 一、技术领域
本发明涉及计算机任务调度与资源治理技术领域，尤其涉及一种面向 CPU/内存/GPU 多资源约束的动态准入与紧急回收方法、系统及存储介质。

## 二、背景技术
现有技术常见问题包括：
1. 仅使用平滑指标判定，突发紧急状态响应滞后。
2. 批量任务同周期提交时，单任务判定“都安全”但累计后越线。
3. 多 GPU 场景下缺少按卡投影，出现跨卡误阻断或误放行。
4. 紧急回收不区分瓶颈维度，容易回收无关任务。
5. 真机重试策略若单向加压，容易出现“仅有安全事件但吞吐为零”。

## 三、发明内容
### （一）技术问题
本发明解决以下问题：
1. 紧急漏检与响应延迟；
2. 同周期批量准入超发；
3. GPU 亲和任务投影不精确；
4. 抢占回收针对性不足；
5. 真机证据中安全目标与吞吐目标难以同时达成。

### （二）技术方案
本发明形成以下联合闭环：
1. 双视图模式判定：紧急看 raw，稳态看 EMA，并结合迟滞与冷却。
2. 同 tick 累计准入投影：每次准入后即更新后续候选基线。
3. per-GPU 亲和投影：按目标卡预算判定，未绑定任务采用保守预算。
4. 瓶颈资源定向抢占：识别热点 GPU，采用归一化回收评分并执行双目标回收停止。
5. 事件驱动双目标重试：同时约束安全目标与吞吐目标。
6. 按失败原因分支的自适应重试（R23）：
 - `insufficient_completion`：放宽阈值并延长调度窗口，避免继续升压导致吞吐进一步受损。
 - `low_signal_dynamic` 或 `missing_emergency_signal`：收紧阈值并提升压力参数，增强紧急/回收可观测性。
 - 每轮记录 `threshold_bias`、`adaptation_action`、`retry_reason`。

### （三）有益效果
1. 保持紧急零延迟响应，同时降低稳态抖动误判。
2. 显著降低批量提交同周期超发风险。
3. 降低跨卡误阻断并提高 GPU 场景准入精度。
4. 在紧急场景提高回收有效性，减少无关任务被回收。
5. 在真机证据链中实现“安全+吞吐”可追溯同时达成。

## 四、附图说明
1. 图1：系统模块结构图。  
2. 图2：调度周期流程图。  
3. 图3：真机三模式对比图（R24 证据样本）。  
4. 图4：自适应重试轨迹图（按失败原因分支调整）。

## 五、具体实施方式
### （一）关键数据对象
1. `ResourceSnapshot`：CPU/内存/交换/GPU 及按卡指标。
2. `TaskSpec`：优先级、资源估算、可抢占标记、目标 GPU 索引。
3. `SchedulerConfig`：阈值、回收、平滑、日志上限与重试参数。
4. `TaskRuntime`：运行状态、停止请求时间、停止原因。

### （二）双视图判定
1. 先用 raw 快照判定紧急条件；
2. 非紧急时用 EMA 判定高压/正常；
3. 退出高压时使用迟滞阈值；
4. 紧急退出后保留冷却周期。

### （三）同 tick 累计投影
1. 维护 `planned_extra_mem_mb`、`planned_extra_cpu_pct`、`planned_extra_gpu_by_index`、`planned_extra_gpu_unbound_mb`；
2. 每次准入成功立即更新上述预算；
3. 后续任务基于更新后的预算继续判定。

### （四）per-GPU 亲和准入
1. 声明目标卡时，仅对目标卡执行投影；
2. 未声明目标卡时，采用保守预算；
3. 目标卡不可用时返回显式阻断原因。

### （五）定向抢占与双目标回收
1. 识别当前瓶颈资源维度与热点 GPU；
2. 计算候选任务归一化回收评分并排序；
3. 同时满足内存回收目标与 GPU 回收目标后停止抢占。

### （六）R23 自适应重试机制
1. 初始化 `threshold_bias=0`；
2. 每轮计算动态阈值并执行真机基线；
3. 若未满足双目标，按失败原因分支：
 - `insufficient_completion`：`threshold_bias += 8`，并增加 `max_scheduler_wall_sec`；
 - `low_signal_dynamic` / `missing_emergency_signal`：`threshold_bias -= 4`，并升压 `task_count/base_mem_mb/duration_sec`；
4. 记录每轮 `threshold_bias`、`adaptation_action`、`retry_reason`、阈值与窗口参数。

### （七）参数实施例
1. `memory_high_pct`: 50~85  
2. `memory_emergency_pct`: `memory_high_pct + 1` 至 95  
3. `ema_alpha`: 0.3~0.8  
4. `preempt_count_per_tick`: 1~4  
5. `max_scheduler_wall_sec`: 12~120  
6. `threshold_bias`: -20~20  

## 六、真机证据（R24）
证据来源：
1. `figures/advanced_research_metrics_R24_completed_ge5_2026-02-13.json`
2. `figures/real_baseline_eventful_R24_summary_2026-02-13.json`
3. `figures/real_baseline_eventful_R24_summary_2026-02-13.csv`

关键结果（双目标：`min_completed=5`）：

| 指标 | 数值 |
|---|---|
| eventful_achieved | 1 |
| attempts_executed | 5 |
| final_completed | 7 |
| final_emergency_ticks | 3 |
| final_preempted_total | 1 |

尝试轨迹节选（R23 分支行为）：

| attempt | retry_reason | adaptation_action | threshold_bias | completed | emergency_ticks |
|---|---|---|---:|---:|---:|
| 1 | low_signal_dynamic | tighten_and_escalate | 0 | 8 | 0 |
| 2 | low_signal_dynamic | tighten_and_escalate | -4 | 8 | 0 |
| 3 | missing_emergency_signal | tighten_and_escalate | -8 | 8 | 0 |
| 4 | insufficient_completion | relax_and_hold | -12 | 2 | 7 |
| 5 | satisfied | stop | -4 | 7 | 3 |

结论：R23 机制能够在同一证据链中将安全目标与吞吐目标同时达成，并保留完整可追溯审计字段。

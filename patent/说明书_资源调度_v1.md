# 说明书（资源调度方向，v1）

- Timestamp: 2026-02-11 13:03:10 +08:00
- 说明: 本说明书用于“资源调度防爆”主线，不对应历史语义记忆方案

## 一、技术领域

本发明涉及计算机任务调度与资源治理技术领域，尤其涉及一种基于 CPU、内存、交换分区及 GPU 多资源观测的动态准入与紧急回收方法、系统及存储介质。

## 二、背景技术

本地开发机或工作站在并发运行多任务时，容易出现以下问题：

1. 任务提交集中在同一时刻，导致短时间资源超发；
2. 单纯依据历史平均值或平滑值判定，可能错过瞬时紧急峰值；
3. GPU 多卡场景下，若仅看总量而不看目标卡，容易误阻断或误放行；
4. 紧急回收若不识别瓶颈资源维度，可能抢占无关任务，造成额外损失。

现有公开技术中，准入、抢占、阈值控制分别存在，但往往是分散实现，缺少面向“防爆保护”目标的联合闭环。

## 三、发明内容

### （一）要解决的技术问题

本发明旨在解决：

1. 紧急峰值漏检导致的系统失稳；
2. 同周期批量准入导致的资源超发；
3. GPU 多卡亲和任务的误判；
4. 紧急回收效率低、误杀多的问题。

### （二）技术方案

本发明提出一种动态资源调度闭环，至少包括以下四层能力：

1. 双视图模式判定：
   - 紧急判定基于原始快照（raw）；
   - 稳态判定基于平滑快照（EMA）；
   - 配合迟滞阈值与紧急冷却周期。
2. 同周期累计准入投影：
   - 每准入一个任务，立即将其估算负载累加到同周期后续任务判定基线；
   - 避免批量提交时“逐个看都安全，合起来越线”的超发风险。
3. per-GPU 亲和准入投影：
   - 任务声明目标 GPU 时，仅对目标卡投影；
   - 未声明目标卡任务采用保守预算（贡献到全部卡或共享预算）。
4. 瓶颈资源定向抢占：
   - 在紧急模式识别瓶颈维度（内存/GPU）；
   - 识别热点 GPU；
   - 基于优先级、归一化回收贡献和亲和性权重排序抢占；
   - 同时满足内存回收目标与 GPU 回收目标后停止抢占。

### （三）有益效果

与现有技术相比，本发明至少具有以下效果：

1. 在突发峰值场景下可零延迟识别紧急状态（raw 路径）；
2. 在稳态下通过 EMA + 迟滞降低抖动；
3. 在批量任务提交场景下显著降低同周期超发风险；
4. 在多 GPU 场景下降低跨卡误阻断；
5. 在紧急回收场景下提高回收针对性，减少无效抢占。

量化示例（来自同仓库可复现实验）：
1. 双视图消融（P-02）中，双视图方案紧急响应延迟为 `0 tick`，EMA-only 基线为 `3 ticks`。
2. 累计投影消融（P-03）中，累计投影方案同 tick 准入 `2` 任务且峰值 `90.8906%`，非累计基线准入 `4` 任务且峰值 `100.6562%`。

## 四、附图说明（草案）

1. 图1：系统模块结构图（监控、判定、准入、回收、审计）
2. 图2：调度主循环时序图（含同周期累计投影）
3. 图3：per-GPU 预算与亲和投影示意图
4. 图4：紧急抢占评分与双目标回收流程图

当前已绘制文件：
1. `patent/附图_资源调度_图1_系统模块.svg`
2. `patent/附图_资源调度_图2_调度周期流程.svg`

## 五、具体实施方式

### （一）关键数据对象

1. `ResourceSnapshot`：时间戳、CPU/内存/交换分区、GPU 聚合指标、GPU 分卡指标；
2. `TaskSpec`：任务优先级、资源估算、可抢占标志、目标 GPU 索引；
3. `SchedulerConfig`：阈值参数、回收参数、平滑参数、日志上限参数；
4. `TaskRuntime`：运行态跟踪、停止请求时间、停止原因。

### （二）模式判定实现

1. 紧急判定条件（示例）：
   - `memory_percent >= memory_emergency_pct`
   - `swap_percent >= swap_emergency_pct`
   - `memory_available_mb <= reserve_memory_mb`
   - `gpu_memory_percent >= gpu_memory_emergency_pct`
2. 若触发紧急，进入 `EMERGENCY` 并设置冷却计数；
3. 非紧急下，再使用 EMA 快照判定 `HIGH/NORMAL`；
4. 从 `HIGH` 回落 `NORMAL` 时应用迟滞退出阈值。

### （三）同周期累计准入实现

1. 本周期准入预算维护：
   - `planned_extra_mem_mb`
   - `planned_extra_cpu_pct`
   - `planned_extra_gpu_by_index`
   - `planned_extra_gpu_unbound_mb`
2. 每次准入成功后增量更新上述预算；
3. 后续候选任务按更新后的预算重新投影；
4. 当预测值超过紧急阈值则阻断并记录原因。

### （四）per-GPU 亲和投影实现

1. 若任务指定 `target_gpu_index`：
   - 读取对应 GPU 卡 `used_mb/total_mb`；
   - 仅叠加目标卡累计预算与 unbound 预算；
2. 若任务未指定目标卡：
   - 叠加各卡预算总和，走保守判定；
3. 若目标卡不可用，返回显式阻断原因。

### （五）瓶颈资源定向抢占实现

1. 识别是否内存紧急、GPU 紧急；
2. 在 GPU 紧急时识别热点 GPU；
3. 对每个可抢占任务计算回收评分：
   - 内存贡献 = 任务内存估算 / 内存回收缺口
   - GPU 贡献 = 有效 GPU 回收 / GPU 回收缺口
4. 评分排序后逐个回收；
5. 当内存目标与 GPU 目标均满足时停止。

### （六）异常与可观测性

1. 终止失败记录 `TASK_STOP_FAILED`；
2. 超时仍未终止时执行强制移除并记录 `TASK_STUCK_REMOVED`；
3. 紧急模式下 pending 任务逐条写入阻断事件，保证可观测性；
4. 事件日志采用上限截断，防止无限增长。

### （七）参数化实施例（具体配置）

实施例 A（单机开发工作站，16GB 内存 + 1~2 GPU）：
1. `memory_high_pct = 85`
2. `memory_emergency_pct = 92`
3. `gpu_memory_high_pct = 85`
4. `gpu_memory_emergency_pct = 95`
5. `reserve_memory_mb = 512`
6. `ema_alpha = 0.6`
7. `mode_hysteresis_pct = 3`
8. `emergency_cooldown_ticks = 2`
9. `preempt_count_per_tick = 1`

实施例 A 的工作过程：
1. 当 raw 内存或显存达到紧急阈值时立即进入紧急模式并阻断准入；
2. 在高压和正常之间切换时使用平滑快照与迟滞阈值，避免短周期抖动；
3. 每次准入后更新同 tick 预算，避免批量提交导致超发；
4. 若进入紧急回收，按归一化回收评分和亲和权重优先回收最相关任务。

## 六、实验性技术效果（可复现实验）

1. 双视图消融（P-02）：
   - 双视图方案：紧急响应延迟 `0` tick；
   - 仅 EMA 方案：紧急响应延迟 `3` ticks。
2. 累计投影消融（P-03）：
   - 累计投影：准入 `2` 个任务，峰值 `90.8906%`；
   - 不累计投影：准入 `4` 个任务，峰值 `100.6562%`（越线）。
3. 以上结果由 `prototype/run_patent_evidence.py` 生成，输出见 `figures/patent_evidence_metrics.json`。

## 七、可实施性说明

本发明可在通用 Linux/Windows 环境实现，支持 dry-run 仿真与真实子进程执行。  
参数可通过配置文件调整，具备可复现实验脚本与测试集，满足工程部署前评估和持续回归需求。
